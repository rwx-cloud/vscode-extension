on:
  github:
    push:
      init:
        ref: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: code
    call: git/clone 2.0.0
    with:
      repository: https://github.com/rwx-cloud/vscode-extension.git
      github-token: ${{ github['rwx-cloud'].token }}
      ref: ${{ init.ref }}

  - key: tool-versions
    use: [code]
    call: rwx/tool-versions 1.0.6

  - key: node
    call: nodejs/install 1.1.11
    with:
      node-version: ${{ tasks.tool-versions.values.nodejs }}

  - key: npm-install
    use: [node, code]
    run: npm install
    filter:
      - package*.json
      - client/package*.json
      - server/package*.json

  - key: compile
    use: npm-install
    run: npm run compile
    filter:
      - client
      - icons
      - server
      - syntaxes
      - "*.json"
      - esbuild.config.js
      - node_modules
